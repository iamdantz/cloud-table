---
import Layout from "../layouts/Layout.astro";
import Sidebar from "../components/Sidebar.astro";
import ServiceTable from "../components/ServiceTable.astro";
import { getCategories, getAllServices } from "../utils/data";
import { Icon } from "astro-icon/components";

const categories = await getCategories();
const services = await getAllServices();

// Default to first category
const defaultCategory = categories[0]?.id || "ai-ml";
---

<Layout title="Cloud Table">
  <Sidebar slot="sidebar" categories={categories} />

  <main class="p-4 md:p-8 max-w-6xl mx-auto w-full">
    <!-- Header Area -->
    <div class="mb-8">
      <div
        class="flex flex-col md:flex-row md:items-center justify-between gap-4"
      >
        <div>
          <h2 id="section-title" class="text-3xl font-bold text-base-content">
            {categories.find((c) => c.id === defaultCategory)?.data.name}
          </h2>
          <p id="section-desc" class="text-base-content/60 mt-1">
            {categories.find((c) => c.id === defaultCategory)?.data.description}
          </p>
        </div>
        <div class="flex items-center gap-3">
          <span
            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success/10 text-success border border-success/20"
          >
            <span class="w-2 h-2 bg-success rounded-full mr-2"></span>
            Up to date: Nov 2025
          </span>

          <!-- Theme Toggle (Desktop) -->
          <label
            class="swap swap-rotate btn btn-ghost btn-circle btn-sm hidden md:inline-grid"
          >
            <input type="checkbox" class="theme-controller" value="dark" />
            <!-- sun icon -->
            <svg
              class="swap-off fill-current w-5 h-5"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              ><path
                d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,5.64,7.05Zm13,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,18.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"
              ></path></svg
            >
            <!-- moon icon -->
            <svg
              class="swap-on fill-current w-5 h-5"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              ><path
                d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"
              ></path></svg
            >
          </label>
        </div>
      </div>
    </div>

    <ServiceTable services={services} />

    <div class="mt-6 text-center text-sm text-base-content/40">
      Disclaimer: AI generated content. Cloud services evolve rapidly. Always
      verify specific capabilities in official documentation. <br />
    </div>
  </main>
</Layout>

<script>
  // Client-side logic for filtering
  const categoryBtns = document.querySelectorAll(".category-btn");
  const searchInput = document.getElementById(
    "global-search"
  ) as HTMLInputElement;
  const serviceRows = document.querySelectorAll(".service-row");
  const sectionTitle = document.getElementById("section-title");
  const sectionDesc = document.getElementById("section-desc");
  const noResultsRow = document.getElementById("no-results");
  const drawerToggle = document.getElementById(
    "my-drawer-2"
  ) as HTMLInputElement;

  let activeCategory = "ai-ml"; // Should match default
  let searchQuery = "";

  // Initialize active state
  updateActiveState();

  // Event Listeners
  categoryBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const catId = btn.getAttribute("data-category");
      if (catId) {
        activeCategory = catId;
        searchQuery = ""; // Clear search on category change
        if (searchInput) searchInput.value = "";
        updateActiveState();
        // Close drawer on mobile
        if (drawerToggle) drawerToggle.checked = false;
        // Scroll to top
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });
  });

  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      searchQuery = (e.target as HTMLInputElement).value.toLowerCase();
      updateActiveState();
    });
  }

  function updateActiveState() {
    // Update sidebar active class
    categoryBtns.forEach((btn) => {
      if (
        btn.getAttribute("data-category") === activeCategory &&
        !searchQuery
      ) {
        btn.classList.add("bg-primary", "text-primary-content");
        btn.classList.remove(
          "text-base-content/70",
          "hover:bg-base-300",
          "hover:text-base-content"
        );
      } else {
        btn.classList.remove("bg-primary", "text-primary-content");
        btn.classList.add(
          "text-base-content/70",
          "hover:bg-base-300",
          "hover:text-base-content"
        );
      }
    });

    // Update Title and Description
    if (searchQuery) {
      if (sectionTitle) sectionTitle.textContent = "Search Results";
      if (sectionDesc)
        sectionDesc.textContent = `Showing results for "${searchQuery}" across all categories`;
    } else {
      const activeBtn = document.querySelector(
        `.category-btn[data-category="${activeCategory}"]`
      );

      if (activeBtn) {
        // Update Title
        if (sectionTitle) {
          // Get text content but exclude icon if possible, or just trim.
          // Since icon is SVG, textContent is mostly the name.
          sectionTitle.textContent = activeBtn.textContent?.trim() || "";
        }

        // Update Description
        const desc = activeBtn.getAttribute("data-description");
        if (sectionDesc && desc) sectionDesc.textContent = desc;
      }
    }

    // Filter Rows
    let visibleCount = 0;
    serviceRows.forEach((row) => {
      const rowCat = row.getAttribute("data-category");
      const rowSearch = row.getAttribute("data-search");

      let isVisible = false;

      if (searchQuery) {
        if (rowSearch && rowSearch.includes(searchQuery)) {
          isVisible = true;
        }
      } else {
        if (rowCat === activeCategory) {
          isVisible = true;
        }
      }

      if (isVisible) {
        row.classList.remove("hidden");
        visibleCount++;
      } else {
        row.classList.add("hidden");
      }
    });

    // Show/Hide No Results
    if (noResultsRow) {
      if (visibleCount === 0) {
        noResultsRow.classList.remove("hidden");
      } else {
        noResultsRow.classList.add("hidden");
      }
    }
  }
</script>
